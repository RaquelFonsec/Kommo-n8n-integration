# ğŸ”„ FLUXOGRAMA DO SISTEMA KOMMO-N8N-PYTHON

## ğŸ“± FLUXO PROATIVO (Bot inicia conversa)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              FLUXO PROATIVO                                    â”‚
â”‚                         (Bot inicia conversa)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   GATILHO   â”‚â”€â”€â”€â–ºâ”‚   PYTHON    â”‚â”€â”€â”€â–ºâ”‚     N8N     â”‚â”€â”€â”€â–ºâ”‚  WHATSAPP   â”‚
â”‚             â”‚    â”‚             â”‚    â”‚             â”‚    â”‚             â”‚
â”‚ â€¢ FormulÃ¡rioâ”‚    â”‚ â€¢ Identificaâ”‚    â”‚ â€¢ Gera      â”‚    â”‚ â€¢ Envia     â”‚
â”‚   preenchidoâ”‚    â”‚   vendedor  â”‚    â”‚   mensagem  â”‚    â”‚   mensagem  â”‚
â”‚ â€¢ Material  â”‚    â”‚ â€¢ Cria      â”‚    â”‚ â€¢ IA        â”‚    â”‚   proativa  â”‚
â”‚   baixado   â”‚    â”‚   conversa  â”‚    â”‚   personalizaâ”‚   â”‚             â”‚
â”‚ â€¢ Agendamentoâ”‚   â”‚ â€¢ Valida    â”‚    â”‚ â€¢ Contexto  â”‚    â”‚             â”‚
â”‚   solicitadoâ”‚    â”‚   Ã¡rea      â”‚    â”‚   completo  â”‚    â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ’¬ FLUXO REATIVO (Cliente responde)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              FLUXO REATIVO                                     â”‚
â”‚                         (Cliente responde)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CLIENTE   â”‚â”€â”€â”€â–ºâ”‚   KOMMO     â”‚â”€â”€â”€â–ºâ”‚   PYTHON    â”‚â”€â”€â”€â–ºâ”‚     N8N     â”‚
â”‚             â”‚    â”‚             â”‚    â”‚             â”‚    â”‚             â”‚
â”‚ â€¢ Envia     â”‚    â”‚ â€¢ Recebe    â”‚    â”‚ â€¢ Processa  â”‚    â”‚ â€¢ IA        â”‚
â”‚   mensagem  â”‚    â”‚   webhook   â”‚    â”‚   webhook   â”‚    â”‚   responde  â”‚
â”‚ â€¢ WhatsApp  â”‚    â”‚ â€¢ Envia     â”‚    â”‚ â€¢ Verifica  â”‚    â”‚ â€¢ Personalizaâ”‚
â”‚   Business  â”‚    â”‚   para API  â”‚    â”‚   bot ativo â”‚    â”‚   resposta  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                              â”‚
                                                              â–¼
                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                   â”‚   KOMMO     â”‚
                                                   â”‚             â”‚
                                                   â”‚ â€¢ Cria nota â”‚
                                                   â”‚ â€¢ Atualiza  â”‚
                                                   â”‚   lead      â”‚
                                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¤– CONTROLE DE BOT (Vendedor assume)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            CONTROLE DE BOT                                     â”‚
â”‚                         (Vendedor assume)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VENDEDOR   â”‚â”€â”€â”€â–ºâ”‚   PYTHON    â”‚â”€â”€â”€â–ºâ”‚     BOT     â”‚â”€â”€â”€â–ºâ”‚   CLIENTE   â”‚
â”‚             â”‚    â”‚             â”‚    â”‚             â”‚    â”‚             â”‚
â”‚ â€¢ Digita    â”‚    â”‚ â€¢ Processa  â”‚    â”‚ â€¢ Pausa     â”‚    â”‚ â€¢ Vendedor  â”‚
â”‚   comando   â”‚    â”‚   comando   â”‚    â”‚   automaticamenteâ”‚ â”‚   assume   â”‚
â”‚ â€¢ /assumir  â”‚    â”‚ â€¢ Atualiza  â”‚    â”‚ â€¢ Para      â”‚    â”‚ â€¢ Atendimentoâ”‚
â”‚ â€¢ /liberar  â”‚    â”‚   status    â”‚    â”‚   respostas â”‚    â”‚   humano    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“… SISTEMA DE AGENDAMENTO

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          SISTEMA DE AGENDAMENTO                                â”‚
â”‚                         (IntegraÃ§Ã£o Supabase)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CLIENTE   â”‚â”€â”€â”€â–ºâ”‚   PYTHON    â”‚â”€â”€â”€â–ºâ”‚     N8N     â”‚â”€â”€â”€â–ºâ”‚  SUPABASE   â”‚
â”‚             â”‚    â”‚             â”‚    â”‚             â”‚    â”‚             â”‚
â”‚ â€¢ Solicita  â”‚    â”‚ â€¢ Identificaâ”‚    â”‚ â€¢ Processa  â”‚    â”‚ â€¢ Armazena  â”‚
â”‚   agendamentoâ”‚   â”‚   vendedor  â”‚    â”‚   dados     â”‚    â”‚   agenda    â”‚
â”‚ â€¢ Escolhe   â”‚    â”‚ â€¢ Valida    â”‚    â”‚ â€¢ Organiza  â”‚    â”‚ â€¢ HistÃ³rico â”‚
â”‚   horÃ¡rio   â”‚    â”‚   disponibilidadeâ”‚ â”‚   informaÃ§Ãµesâ”‚   â”‚ â€¢ Vendedor  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ CENÃRIOS DE USO

### **CenÃ¡rio 1: Cliente preenche formulÃ¡rio**
```
1. Cliente preenche formulÃ¡rio no site
2. Kommo cria lead e contato
3. Python recebe webhook ou chamada manual
4. Sistema identifica vendedor responsÃ¡vel
5. Cria conversa proativa no cache
6. Envia dados para n8n com contexto completo
7. n8n gera mensagem personalizada
8. Mensagem Ã© enviada via WhatsApp
9. Sistema cria nota no lead do Kommo
```

### **CenÃ¡rio 2: Cliente responde mensagem**
```
1. Cliente envia mensagem no WhatsApp
2. Kommo recebe mensagem e envia webhook
3. Python processa webhook e verifica status do bot
4. Se bot ativo, envia para n8n
5. n8n gera resposta personalizada
6. Resposta Ã© enviada via Kommo
7. Sistema registra interaÃ§Ã£o no lead
```

### **CenÃ¡rio 3: Vendedor assume conversa**
```
1. Vendedor digita "/assumir 12345" no WhatsApp Business
2. Kommo envia webhook (nÃ£o Ã© do contato)
3. Python detecta comando e pausa bot
4. Bot fica pausado para aquele contato
5. Vendedor pode atender cliente normalmente
6. Vendedor digita "/liberar 12345"
7. Bot reativa automaticamente
```

### **CenÃ¡rio 4: Cliente solicita agendamento**
```
1. Cliente solicita agendamento durante conversa
2. Python identifica vendedor responsÃ¡vel
3. Sistema envia dados estruturados para n8n
4. n8n processa e envia para Supabase
5. Dados sÃ£o armazenados na tabela especÃ­fica do vendedor
6. Sistema confirma agendamento para o cliente
```

## ğŸ”§ COMPONENTES TÃ‰CNICOS

### **Python API (FastAPI)**
- **Porta**: 8000
- **Endpoints**: 26 endpoints ativos
- **Funcionalidades**: Webhooks, controle de bot, vendedores, agendamento

### **Kommo API**
- **URL**: `https://previdas.kommo.com/api/v4/`
- **AutenticaÃ§Ã£o**: OAuth2 + Access Token
- **Endpoints**: `/users`, `/leads`, `/contacts`, `/leads/{id}/notes`

### **n8n (AutomaÃ§Ã£o)**
- **FunÃ§Ã£o**: IA/LLM + Workflows
- **IntegraÃ§Ã£o**: Webhooks bidirecionais
- **Funcionalidades**: Respostas personalizadas, agendamentos, Supabase

### **Supabase (Banco)**
- **FunÃ§Ã£o**: Armazenamento de agendamentos
- **IntegraÃ§Ã£o**: Via n8n
- **Tabelas**: `agenda_[vendedor]`, `vendedores`, `histÃ³rico`

## ğŸ“Š MÃ‰TRICAS E MONITORAMENTO

### **Taxa de Sucesso**
- âœ… **100%** dos endpoints funcionais
- âœ… **9 vendedores reais** sincronizados
- âœ… **3 vendedores fictÃ­cios** para testes
- âœ… **26 endpoints** ativos

### **Performance**
- **Cache inteligente** para vendedores
- **Processamento assÃ­ncrono** de webhooks
- **Logs estruturados** para monitoramento
- **Health checks** automÃ¡ticos

### **Confiabilidade**
- **Tratamento de erros** robusto
- **Fallbacks** para APIs externas
- **ValidaÃ§Ã£o de dados** com Pydantic
- **Retry logic** para falhas temporÃ¡rias

---

**Este fluxograma representa o funcionamento completo do sistema de integraÃ§Ã£o Kommo-n8n-Python, mostrando todos os fluxos de dados e interaÃ§Ãµes entre os componentes.**

